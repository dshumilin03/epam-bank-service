<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Manager Dashboard - Epam Bank</title>
    <style>
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }
        .transaction-item {
            border-bottom: 1px dotted #eee;
            padding: 5px 0;
        }
    </style>
</head>
<body>

<div th:replace="fragments/header :: header"></div>

<div style="display:flex; justify-content: space-between; margin-top:20px; padding: 0 20px;">

    <div style="width:25%;">
        <h3>Search user</h3>
        <form th:action="@{/manager}" method="get">
                <input
                        type="text"
                        name="full_name"
                        placeholder="Full name"
                        required
                        th:value="${param.full_name}"
                />
            <button type="submit">Find</button>
        </form>

        <div th:if="${searchError}" style="color:red; margin-top: 15px;">
            <p th:text="${searchError}"></p>
        </div>

    </div>

    <div style="width:40%;">
        <h3>Client information</h3>

        <div th:if="${foundUser}">
            <p><strong>Full name:</strong> <span th:text="${foundUser.getFullName()}"></span></p>
            <p><strong>Passport ID:</strong> <span th:text="${foundUser.getPassportId()}"></span></p>
            <p><strong>Account Number:</strong> <span th:text="${foundUser.getBankAccount().bankAccountNumber()}"></span></p>

            <p>
                <strong>Disabled :</strong>
                <span th:text="${foundUser.isDisabled}" th:style="${foundUser.isDisabled ? 'color: red;' : 'color: green;'}"></span>
            </p>
            <hr/>

            <h4>User Status Management</h4>
            <form th:action="@{/toggle-disable-user}" method="post">

                <input
                        type="hidden"
                        name="userId"
                        th:value="${foundUser.getId()}"
                        required
                />

                <input
                        type="hidden"
                        name="fullName"
                        th:value="${param.full_name}"
                        th:if="${param.full_name}"
                />

                <button type="submit"
                        th:text="${foundUser.isDisabled ? 'ACTIVATE User' : 'DISABLE User'}">
                    Toggle Status
                </button>
            </form>

            <div th:if="${toggleSuccess}" style="color:green; margin-top: 10px;">
                <p th:text="${toggleSuccess}"></p>
            </div>
            <div th:if="${toggleError}" style="color:red; margin-top: 10px;">
                <p th:text="${toggleError}"></p>
            </div>

            <hr/>
        </div>

        <div th:unless="${foundUser}">
            <p>Search user to get information</p>
        </div>
    </div>

    <div style="width:35%;">
        <h3>Transactions</h3>

        <div th:if="${foundUser}">

            <h4>Outgoing Transactions</h4>
            <div th:if="${userOutgoingTransactions != null and !userOutgoingTransactions.isEmpty()}" class="transaction-list">
                <div th:each="transaction : ${userOutgoingTransactions}" class="transaction-item">
                    <p>
                        ID: <span th:text="${transaction.id}"></span> |
                        amount: <span th:text="${transaction.moneyAmount}"></span> |
                        receiver: <span th:text="${transaction.targetBankAccountNumber}"></span> |
                        date: <span th:text="${transaction.createdAt}"></span>
                    </p>
                </div>
            </div>
            <div th:unless="${userOutgoingTransactions != null and !userOutgoingTransactions.isEmpty()}">
                <p>No outgoing transactions</p>
            </div>

            <h4>Incoming transactions</h4>
            <div th:if="${userIncomingTransactions != null and !userIncomingTransactions.isEmpty()}" class="transaction-list">
                <div th:each="transaction : ${userIncomingTransactions}" class="transaction-item">
                    <p>
                        ID: <span th:text="${transaction.id}"></span> |
                        amount: <span th:text="${transaction.moneyAmount}"></span> |
                        sender: <span th:text="${transaction.sourceBankAccountNumber}"></span> |
                        date: <span th:text="${transaction.createdAt}"></span> |
                        status: <span th:text="${transaction.status.toString()}"></span>
                    </p>
                </div>
            </div>
            <div th:unless="${userIncomingTransactions != null and !userIncomingTransactions.isEmpty()}">
                <p>No incoming transactions</p>
            </div>

            <hr/>

            <h4>Rollback transaction</h4>
            <form th:action="@{/manager}" method="post">
                <input
                        type="text"
                        name="transactionId"
                        placeholder="Transaction ID (UUID)"
                        required
                />
                <button type="submit">rollback</button>
            </form>

            <div th:if="${rollbackSuccess}" style="color:green; margin-top: 10px;">
                <p>Transaction successfully refunded</p>
            </div>
            <div th:if="${rollbackError}" style="color:red; margin-top: 10px;">
                <p th:text="${rollbackError}"></p>
            </div>

        </div>

    </div>

    <div style="width:40%;">
        <h3>Charge User</h3>

        <div th:if="${foundUser}">

            <h4 style="margin-top: 15px;">Apply Charge to Loan</h4>
            <input
                    type="hidden"
                    name="fullName"
                    th:value="${param.full_name}"
                    th:if="${param.full_name}"
            />
            <form th:action="@{/manager/user}" method="post">
                <label for="loanSelect">Select Loan:</label>
                <select name="loanId" id="loanSelect" required>
                    <option th:if="${userLoans == null or userLoans.isEmpty()}" value="" disabled selected>
                        No active loans found
                    </option>

                    <option
                            th:each="loan : ${userLoans}"
                            th:value="${loan.id}"
                            th:text="'ID: ' + ${loan.id} + ' | Amount Left: ' + ${loan.moneyLeft}">
                    </option>
                </select>
                <br/><br/>
                <button type="submit" th:disabled="${userLoans == null or userLoans.isEmpty()}">Apply Charge</button>
            </form>

        </div>

        <div th:unless="${foundUser}">
            <p>Search user to get information</p>
        </div>
    </div>
</div>
</body>
</html>